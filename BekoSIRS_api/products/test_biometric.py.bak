# products/test_biometric.py
"""
Tests for biometric authentication endpoints.
"""

from django.test import TestCase
from rest_framework import status

from products.models import CustomUser
from products.conftest import APITestCase


class BiometricModelTest(TestCase):
    """Tests for biometric fields on CustomUser model."""

    def test_biometric_fields_default_values(self):
        """New user should have biometric disabled by default."""
        user = CustomUser.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='TestPass123!'
        )
        
        self.assertFalse(user.biometric_enabled)
        self.assertIsNone(user.biometric_device_id)


class BiometricAPITest(APITestCase):
    """Tests for biometric API endpoints."""

    def test_enable_biometric_requires_auth(self):
        """Enable endpoint should require authentication."""
        response = self.client.post('/api/biometric/enable/', {
            'device_id': 'test-device-123',
            'refresh_token': 'test-token'
        })
        self.assertEqual(response.status_code, status.HTTP_401_UNAUTHORIZED)

    def test_enable_biometric_success(self):
        """Authenticated user can enable biometric."""
        self.authenticate_customer()
        
        response = self.client.post('/api/biometric/enable/', {
            'device_id': 'ios_test_device_123',
            'refresh_token': 'test-refresh-token'
        })
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data['success'])
        self.assertTrue(response.data['biometric_enabled'])
        
        # Verify in database
        self.customer_user.refresh_from_db()
        self.assertTrue(self.customer_user.biometric_enabled)
        self.assertEqual(self.customer_user.biometric_device_id, 'ios_test_device_123')

    def test_disable_biometric_success(self):
        """Authenticated user can disable biometric."""
        self.authenticate_customer()
        
        # First enable
        self.customer_user.biometric_enabled = True
        self.customer_user.biometric_device_id = 'test-device'
        self.customer_user.save()
        
        response = self.client.post('/api/biometric/disable/')
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data['success'])
        self.assertFalse(response.data['biometric_enabled'])
        
        # Verify in database
        self.customer_user.refresh_from_db()
        self.assertFalse(self.customer_user.biometric_enabled)
        self.assertIsNone(self.customer_user.biometric_device_id)

    def test_get_biometric_status(self):
        """Can get biometric status for authenticated user."""
        self.authenticate_customer()
        
        response = self.client.get('/api/biometric/status/')
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('biometric_enabled', response.data)
        self.assertIn('has_device', response.data)

    def test_verify_device_valid(self):
        """Valid device should be verified."""
        # Enable biometric for customer
        self.customer_user.biometric_enabled = True
        self.customer_user.biometric_device_id = 'valid-device-id'
        self.customer_user.save()
        
        response = self.client.post('/api/biometric/verify-device/', {
            'device_id': 'valid-device-id',
            'user_id': self.customer_user.id
        })
        
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTrue(response.data['success'])
        self.assertEqual(response.data['user_id'], self.customer_user.id)

    def test_verify_device_invalid_device(self):
        """Invalid device ID should fail verification."""
        self.customer_user.biometric_enabled = True
        self.customer_user.biometric_device_id = 'valid-device-id'
        self.customer_user.save()
        
        response = self.client.post('/api/biometric/verify-device/', {
            'device_id': 'wrong-device-id',
            'user_id': self.customer_user.id
        })
        
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
        self.assertFalse(response.data['success'])

    def test_verify_device_biometric_disabled(self):
        """Should fail if biometric not enabled for user."""
        self.customer_user.biometric_enabled = False
        self.customer_user.save()
        
        response = self.client.post('/api/biometric/verify-device/', {
            'device_id': 'any-device',
            'user_id': self.customer_user.id
        })
        
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
        self.assertFalse(response.data['success'])

    def test_verify_device_nonexistent_user(self):
        """Should fail for nonexistent user."""
        response = self.client.post('/api/biometric/verify-device/', {
            'device_id': 'any-device',
            'user_id': 99999
        })
        
        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)

import pytest
from django.urls import reverse
from rest_framework import status
from products.models import Notification
from .conftest import APITestCase

@pytest.mark.django_db
class TestNotificationSystem(APITestCase):
    def setUp(self):
        super().setUp()
        
        self.settings_url = reverse('notification-settings')
        self.send_bulk_url = reverse('notification-send-bulk')
        self.my_notifications_url = reverse('notification-list')

    def test_default_notification_settings_created(self):
        self.authenticate_customer()
        response = self.client.get(self.settings_url)
        
        assert response.status_code == status.HTTP_200_OK
        # Modeldeki varsayılan değerler True
        assert response.data['notify_general'] is True
        assert response.data['notify_price_drops'] is True

    def test_update_notification_settings(self):
        self.authenticate_customer()
        
        data = {
            'notify_general': False,
            'notify_price_drops': False
        }
        response = self.client.patch(self.settings_url, data, format='json')
        assert response.status_code == status.HTTP_200_OK
        assert response.data['settings']['notify_general'] is False # Response yapısı {success: True, settings: {...}}
        assert response.data['settings']['notify_price_drops'] is False
        
        # Diğerleri değişmemeli (default True)
        assert response.data['settings']['notify_restock'] is True 

    def test_admin_send_bulk_notification(self):
        self.authenticate_admin()
        
        data = {
            'title': 'Kampanya!',
            'message': 'Büyük indirim var.',
            'target_audience': 'all'
        }
        
        response = self.client.post(self.send_bulk_url, data)
        assert response.status_code == status.HTTP_200_OK
        
        # Kullanıcıya bildirim gitmiş mi?
        notif = Notification.objects.filter(user=self.customer_user).first()
        assert notif is not None
        assert notif.title == 'Kampanya!'
        assert notif.is_read is False

    def test_customer_can_read_notifications(self):
        self.authenticate_customer()
        
        # Bildirim oluştur
        n1 = Notification.objects.create(user=self.customer_user, title="Test", message="Mesaj")
        
        response = self.client.get(self.my_notifications_url)
        assert response.status_code == status.HTTP_200_OK
        assert len(response.data) >= 1
        
        # Okundu işaretle
        try:
            url = reverse('notification-mark-as-read', args=[n1.id])
        except:
             url = f'/api/notifications/{n1.id}/read/'
             
        response = self.client.post(url)
        assert response.status_code == status.HTTP_200_OK
        
        n1.refresh_from_db()
        assert n1.is_read is True
